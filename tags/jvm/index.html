<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8" >
    <meta name="baidu-site-verification" content="dIcXMeY8Ya" />
    
    <title>`jvm`标签下的文章 | Steve</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" >
    <meta name="keywords" content="Steve, java Web, python, 刘兴厚, 后端开发" >
    <meta name="description" content="Steve的个人博客" >

    
    <link rel="alternative" href="/atom.xml" title="Steve" type="application/atom+xml" >
    
    
    <link rel="shortcut icon" href="/favicon.ico" >
    
    <link rel="stylesheet" href="/css/style.css">
    <!--[if lt IE 9]>
    <script src="/js/html5.js"></script>
    <![endif]-->
    

</head>

<body class="home">
    <!--[if lt IE 9]>
    <div class="browsehappy">
        当前网页 <strong>不支持</strong>
        你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/">升级你的浏览器</a>.
    </div>
    <![endif]-->

    <!-- 博客头部 -->
    <header class="header">
    <section class="container header-main">
        <div class="logo">
            <a href="/">
                <div class="cover">
                    <span class="name">Steve</span>
                    <span class="description"></span>
                </div>
            </a>
        </div>
        <div class="dropnav icon-paragraph-justify" id="JELON__btnDropNav"></div>
        <ul class="menu hidden" id="JELON__menu">
            
            <li rel="/tags/jvm/index.html" class="item ">
                <a href="/" title="Index" class="icon-home">&nbsp;Index</a>
            </li>
            
            <li rel="/tags/jvm/index.html" class="item ">
                <a href="/weekly/" title="Life" class="icon-lab">&nbsp;Life</a>
            </li>
            
            <li rel="/tags/jvm/index.html" class="item ">
                <a href="/about/" title="About" class="icon-about">&nbsp;About</a>
            </li>
            
            <li rel="/tags/jvm/index.html" class="item ">
                <a href="/comment/" title="Message" class="icon-comment">&nbsp;Message</a>
            </li>
            
        </ul>
        <div class="profile clearfix">
            <div class="feeds fl">
                
                
                <p class="links">
                    <!-- 
                        <a href="https://github.com/jangdelong" target="_blank">Github</a>
                        |
                    
                        <a href="https://pages.coding.me" target="_blank">Hosted by Coding Pages</a>
                        
                     -->
                </p>
                <p class="sns">
                    <!-- 
                        <a href="http://weibo.com/jangdelong" class="sinaweibo" target="_blank"><b>■</b> 新浪微博</a>
                    
                        <a href="https://www.facebook.com/profile.php?id=100011855760219&amp;ref=bookmarks" class="qqweibo" target="_blank"><b>■</b> Facebook</a>
                     -->
                    <!-- <a href="javascript: void(0);" class="wechat">
                        <b>■</b>
                        公众号
                        <span class="popover">
                            <img src="/img/wechat_mp.jpg" width="120" height="120" alt="我的微信订阅号">
                            <i class="arrow"></i>
                        </span>
                    </a> -->
                </p>
                
            </div>
            <!-- <div class="avatar fr">
                <img src="/img/jelon.jpg" alt="avatar" title="Jelon" >
            </div> -->
        </div>
    </section>
</header>


    <!-- 博客正文 -->
    <div class="container body clearfix">
        <section class="content">
            <div class="content-main widget">
                <!-- 按标签分类 -->

    <h3 class="widget-hd">
        <strong>
            
                `jvm`标签下的文章
            
        </strong>
    </h3>
    
        <!-- 文章 -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="/categories/Java/">Java</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="https://995270418l.github.io/2018/01/31/jvm/">
    		jvm学习(java se8)
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        steve 发表于
        <time datetime="2018-01-30T16:00:00.000Z">2018-01-31</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="/tags/jvm/" title="jvm">jvm</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <h2 id="1-各种jvm特点介绍-包含以前的"><a href="#1-各种jvm特点介绍-包含以前的" class="headerlink" title="1.各种jvm特点介绍(包含以前的):"></a>1.各种jvm特点介绍(包含以前的):</h2><ol>
<li>Sun Classic VM (jdk1.1 版本的虚拟机)<blockquote>
<p>特点: 全世界第一个商用的虚拟机，只能使用纯解释器的方式来执行java代码</p>
</blockquote>
</li>
<li>Exact VM (jdk1.2 solari平台)<blockquote>
<p>特点: 开始具备高性能vm的特点，有准确性内存管理，解释器和编译器混合使用以及二级即时编译特性，但是只在jdk1.2的solari平台使用过</p>
</blockquote>
</li>
<li>HotSpot VM (jdk1.3发布)<blockquote>
<p>特点: 热点代码追踪技术等等</p>
</blockquote>
</li>
<li>KVM (j2ME 时代sun公司的产物)<blockquote>
<p>特点:简单，轻便，就是比较慢</p>
</blockquote>
</li>
<li>JRockit VM (sun公司的产品，2008年呗Oracle收购之后就呗HotSpot整合了)<blockquote>
<p>特点: 快，有垃圾收集器，MissionControl控制套件（用来控制生产环境内存泄漏的）</p>
</blockquote>
</li>
<li>J9 VM (IBM 为自家java程序开发的一个VM)<blockquote>
<p>特点: 高度模块化，任意平台通用（SE,EE,ME），快</p>
</blockquote>
</li>
<li>DalVik (android 平台的VM)<blockquote>
<p>特点: 性能好，快.只限android平台使用</p>
</blockquote>
</li>
</ol>
<p>扩展: <a href="https://www.zhihu.com/question/29265430" target="_blank" rel="external">目前主流的 Java 虚拟机有哪些?</a></p>
<h2 id="2-JVM-的内存管理"><a href="#2-JVM-的内存管理" class="headerlink" title="2.JVM 的内存管理"></a>2.JVM 的内存管理</h2><p>jvm的内存管理分为两大部分，线程共享区和线程独占区,具体划分看下图:</p>
<p><img src="/img/运行时数据区.png" alt=""></p>
<p>接下来重点讲解几个重要的概念:</p>
<h3 id="2-1动态常量池"><a href="#2-1动态常量池" class="headerlink" title="2.1动态常量池"></a>2.1动态常量池</h3><pre><code>存在于方法区中，常量都是不变的，为什么叫动态常量池呢，就是因为这个池可以动态的增加(String的intern()方法)，看以下代码：

String a = &quot;abc&quot;;
String b = &quot;abc&quot;;

logger.info(a == b);  // 1

String c = new String(&quot;abc&quot;);

logger.info(b == c);  // 2

logger.info(b == c.intern()); // 3
</code></pre><p>在这里变量a和b就是一个常量，值存放在java的线程共享区的方法区中，引用存放在线程独享区中的虚拟机栈中，在方法区中存在一个StringTable相当于一个HashSet，只会存在一个“abc”实例，所以1对应的输出为true。<br>变量c的引用存放在线程独享区中的虚拟机栈中，值因为是一个变量，存放在线程共享区中的java堆中，所以和b变量的地址不同，2的对应输出为false。<br>当调用c.intern()方法时，jvm会将对应的值从java堆移动到方法区中，即动态常量池中。所以3对应的输出为true,对应的流程图如下:</p>
<p><img src="/img/变量比较.png" alt=""></p>
<h3 id="2-2直接内存"><a href="#2-2直接内存" class="headerlink" title="2.2直接内存"></a>2.2直接内存</h3><p>java的NIO使用，javaNIO是一种面向缓冲的技术实现框架，其中缓冲的内存使用的不是java堆内存，使用的是直接内存，当然同样受限于物理机器的内存。</p>
<h3 id="2-3对象在内存中的布局"><a href="#2-3对象在内存中的布局" class="headerlink" title="2.3对象在内存中的布局"></a>2.3对象在内存中的布局</h3><p>对象的创建步骤:<br><img src="/img/对象初始化.png" alt=""></p>
<p>变量包括数据头(header)和变量值(instanceData)和填充(padding)，数据头包含了变量的各种运行时数据(哈希值，GC分代年龄，锁状态标志，线程持有的锁，偏向线程ID，偏向时间戳…)和类型指针。变量值就是变量的值，填充是由于数据的大小只能为8的倍数，当数据大小不为8的倍数时，就会进行填充位数。</p>
<h2 id="3-垃圾回收"><a href="#3-垃圾回收" class="headerlink" title="3. 垃圾回收"></a>3. 垃圾回收</h2><h3 id="3-1-在哪里进行垃圾回收？"><a href="#3-1-在哪里进行垃圾回收？" class="headerlink" title="3.1 在哪里进行垃圾回收？"></a>3.1 在哪里进行垃圾回收？</h3><p>大部分是线程共享区的java堆，小部分是线程共享区的方法区(可设置关闭这个区的 GC)</p>
<h3 id="3-2什么时候开始回收"><a href="#3-2什么时候开始回收" class="headerlink" title="3.2什么时候开始回收?"></a>3.2什么时候开始回收?</h3><p>如今的JVM在java堆里面分了两个代，新生代和老年代。新生代里面有三个区，Eden区和两个survivor区。当Eden区满的时候，会触发一次 Minor GC，会将Eden区中剩余的对象拷贝至一个survivor区中，对象的存活年龄加1,清空Eden区，再次存放对象，等Eden区再次满的时候，触发 Minor GC，将Eden区中剩余的对象和survivor区剩余的对象移动至另一个survivor区中，存活年龄再+1。等年龄增长到了默认值的时候，剩余的对象就会从新生代复制到老年代。当老年代快要满的时候（虚拟机会检查每次晋升进入老年代的大小是否大于老年代的剩余空间大小），如果大于，直接触发 Minor GC. 如果不停的 Minor GC 下去，老年代还是要满了，就会根据配置的参数来决定是要同时执行FULL GC 和 Minor GC 还是只执行 Minor GC 。</p>
<h3 id="3-3-怎么回收？"><a href="#3-3-怎么回收？" class="headerlink" title="3.3 怎么回收？"></a>3.3 怎么回收？</h3><p>回收算法有两类：</p>
<ul>
<li><p>引用计数收集算法</p>
<p>  判断对象的实例是否不再被引用了。当引用为0的时候，就把他标记清除。这样有个问题就是当别的对象实例引用它而引用指针为null的时候，这个就不会被收集。导致垃圾存留。这个算法已经不被使用了。</p>
</li>
<li><p>可达性分析法</p>
<p>  可达性分析法都是需要从根GC 扫描判断对象是否被引用，被引用了就标记起来，扫描完了后再扫描一遍内存，查看哪些对象没被标记，没被标记则为待回收对象。针对所有的对象衍生出三种收集方法</p>
<ol>
<li>复制法：新开辟一片内存区域，每标记一个对象，就将标记对象复制一份到新内存上。虽然需要消耗一定的内存，但在对象数量特别少的时候这个算法特别高效(新生代的Eden区使用的就是它)。</li>
<li>标记-清除算法： 清除所有待回收对象，然后不对内存进行整理，导致内存空间不连续，生成内存碎片。</li>
<li>标记-整理算法: 在清除完所有待回收对象之后，对内存进行整理排序，虽然成本增加了，但效率确实提高了不少。<br>根GC 对象的选择: 虚拟机栈中所引用的对象，方法区中类的引用的对象，方法区中常量的引用的对象，本地方法区中引用的对象。四种选择方案</li>
</ol>
</li>
</ul>
<h3 id="3-4-垃圾收集器"><a href="#3-4-垃圾收集器" class="headerlink" title="3.4 垃圾收集器"></a>3.4 垃圾收集器</h3><ul>
<li>Serial 垃圾收集器<br>Serial垃圾收集器是最初的垃圾收集器，在GC的时候需要停止用户线程，如果待回收对象太大会造成卡顿现象，适合于client端的java应用。</li>
</ul>
<p><img src="/img/Serial.png" alt=""></p>
<ul>
<li>ParNew 垃圾收集器<br>在Serial垃圾收集器的基础上增加了并发收集的实现。可和Cms垃圾收集器一起工作(ParNew负责新生代的收集工作)，</li>
</ul>
<p><img src="/img/ParNew.png" alt=""></p>
<ul>
<li><p>Parallel 垃圾收集器<br>也是并行的多线程收集器，只不过关注点在于控制垃圾收集的吞吐量（其他的关注点在于减少垃圾的收集时间）。</p>
</li>
<li><p>Cms垃圾收集器<br>这个是可以并发执行的一款垃圾收集器,执行流程如下图:</p>
</li>
</ul>
<p><img src="/img/cms.png" alt=""></p>
<ul>
<li>G1 垃圾收集器<br>目前为止最牛逼的垃圾收集器，智能型垃圾收集器，虽然原理和流程和Cms垃圾收集器一样，但是里面却有几个不同的概念，比如Region，可预测时间模型等等。</li>
</ul>
<p>参考: <a href="https://crowhawk.github.io/2017/08/15/jvm_3/" target="_blank" rel="external">深入理解JVM(3)——7种垃圾收集器</a><br>扩展: <a href="http://blog.csdn.net/suifeng3051/article/details/48292193" target="_blank" rel="external">JVM内存管理及GC机制</a></p>
<h2 id="4-内存分配"><a href="#4-内存分配" class="headerlink" title="4 内存分配"></a>4 内存分配</h2><h3 id="4-1-对象优先分配到Eden区上"><a href="#4-1-对象优先分配到Eden区上" class="headerlink" title="4.1 对象优先分配到Eden区上"></a>4.1 对象优先分配到Eden区上</h3><p>在jvm中，除大对象以外，所有的对象几乎都是优先分配Eden区里面，看以下代码:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> M = <span class="number">1024</span> * <span class="number">1024</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    <span class="keyword">byte</span>[] b1 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * M];</div><div class="line">    <span class="keyword">byte</span>[] b2 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * M];</div><div class="line">    <span class="keyword">byte</span>[] b3 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span> * M];</div><div class="line">    <span class="keyword">byte</span>[] b4 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span> * M];</div><div class="line"></div><div class="line">    System.gc();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>配置运行参数为: -Xms20m -Xmx20m -Xmn10m  -verbose:gc -XX:+PrintGCDetails -XX:SurvivorRatio=8 运行结果如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[GC (Allocation Failure) [PSYoungGen: <span class="number">6914</span>K-&gt;<span class="number">952</span>K(<span class="number">9216</span>K)] <span class="number">6914</span>K-&gt;<span class="number">5056</span>K(<span class="number">19456</span>K), <span class="number">0.0045301</span> secs] [Times: user=<span class="number">0.05</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </div><div class="line">[GC (System.gc()) --[PSYoungGen: <span class="number">7252</span>K-&gt;<span class="number">7252</span>K(<span class="number">9216</span>K)] <span class="number">11356</span>K-&gt;<span class="number">13412</span>K(<span class="number">19456</span>K), <span class="number">0.0019800</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </div><div class="line">[<span class="function">Full <span class="title">GC</span> <span class="params">(System.gc()</span>) [PSYoungGen: 7252K-&gt;4840<span class="title">K</span><span class="params">(<span class="number">9216</span>K)</span>] [ParOldGen: 6160K-&gt;6145<span class="title">K</span><span class="params">(<span class="number">10240</span>K)</span>] 13412K-&gt;10986<span class="title">K</span><span class="params">(<span class="number">19456</span>K)</span>, [Metaspace: 3494K-&gt;3494<span class="title">K</span><span class="params">(<span class="number">1056768</span>K)</span>], 0.0071106 secs] [Times: user</span>=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.01</span> secs] </div><div class="line">Heap</div><div class="line"> PSYoungGen      total <span class="number">9216</span>K, used <span class="number">5087</span>K [<span class="number">0x00000000ff600000</span>, <span class="number">0x0000000100000000</span>, <span class="number">0x0000000100000000</span>)</div><div class="line">  eden space <span class="number">8192</span>K, <span class="number">62</span>% used [<span class="number">0x00000000ff600000</span>,<span class="number">0x00000000ffaf7c38</span>,<span class="number">0x00000000ffe00000</span>)</div><div class="line">  from space <span class="number">1024</span>K, <span class="number">0</span>% used [<span class="number">0x00000000ffe00000</span>,<span class="number">0x00000000ffe00000</span>,<span class="number">0x00000000fff00000</span>)</div><div class="line">  to   space <span class="number">1024</span>K, <span class="number">0</span>% used [<span class="number">0x00000000fff00000</span>,<span class="number">0x00000000fff00000</span>,<span class="number">0x0000000100000000</span>)</div><div class="line"> ParOldGen       total <span class="number">10240</span>K, used <span class="number">6145</span>K [<span class="number">0x00000000fec00000</span>, <span class="number">0x00000000ff600000</span>, <span class="number">0x00000000ff600000</span>)</div><div class="line">  object space <span class="number">10240</span>K, <span class="number">60</span>% used [<span class="number">0x00000000fec00000</span>,<span class="number">0x00000000ff200518</span>,<span class="number">0x00000000ff600000</span>)</div><div class="line"> Metaspace       used <span class="number">3509</span>K, capacity <span class="number">4498</span>K, committed <span class="number">4864</span>K, reserved <span class="number">1056768</span>K</div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">space</span>    <span class="title">used</span> 387<span class="title">K</span>, <span class="title">capacity</span> 390<span class="title">K</span>, <span class="title">committed</span> 512<span class="title">K</span>, <span class="title">reserved</span> 1048576<span class="title">K</span></span></div></pre></td></tr></table></figure></p>
<p>这里设置了Eden区大小为8M，两个Survivor区各1M，老年代10M。开始将b1,b2,b3都分配在Eden区，在分配b4的时候，会用到空间分配担保(-XX:+HandlePromotionFailure)技术(jdk8默认开启),然后会将b1,b2,b3 分配至老年代，b4分配到Eden区，占4M</p>
<h3 id="4-2-大对象优先分配到老年代"><a href="#4-2-大对象优先分配到老年代" class="headerlink" title="4.2 大对象优先分配到老年代"></a>4.2 大对象优先分配到老年代</h3><p>在jvm的理解中，大对象一般不会变化的，所以会将大对象放入老年代。大对象的确定是动态确定的，根据你设置的Eden去大小而定，大于Eden区，就是大对象，直接将其放入老年代储存。</p>
<h3 id="4-3多次存活的对象分配到老年代"><a href="#4-3多次存活的对象分配到老年代" class="headerlink" title="4.3多次存活的对象分配到老年代"></a>4.3多次存活的对象分配到老年代</h3><p>jvm有一个存活阈值，对象生存年龄大于这个阈值就会将对象存入老年代，对象实际进入年老代的年龄是虚拟机在运行时根据内存使用情况动态计算的，有可能存活一两次就进去了。设置阈值的参数是: -XX:MaxTenuringThreshold=15 这个参数指定的是阈值年龄的最大值,默认是15</p>
<h3 id="4-4-逃逸分析和栈上分配"><a href="#4-4-逃逸分析和栈上分配" class="headerlink" title="4.4 逃逸分析和栈上分配"></a>4.4 逃逸分析和栈上分配</h3><p>对象放入堆区之前会进行逃逸分析，当方法内的对象不引用别的方法区域内的对象或者全局变量，则称该变量不发生逃逸，会将该变量进行栈上分配，也就是分配到线程独占区的虚拟机栈区里面。否则分配到java堆里面。</p>
<p>本节扩展<a href="http://blog.csdn.net/u013295276/article/details/78468790" target="_blank" rel="external">【JVM】12_空间分配担保</a></p>
<h2 id="5-性能分析工具"><a href="#5-性能分析工具" class="headerlink" title="5 性能分析工具"></a>5 性能分析工具</h2><h3 id="5-1-Jps"><a href="#5-1-Jps" class="headerlink" title="5.1 Jps"></a>5.1 Jps</h3><p>jps 就是查看java进程id和开启进程具体命令的一个工具.类似linux的ps命令. 常用使用方法为: jps -mlv   (-m: 查看运行的参数，-l: 具体到包名的运行类, -v: 查看运行的vm参数)。 结果截图:</p>
<p><img src="/img/jps.png" alt=""></p>
<h3 id="5-2-Jstat"><a href="#5-2-Jstat" class="headerlink" title="5.2 Jstat"></a>5.2 Jstat</h3><p>jstat 是用来查看java进程的各种详细信息，类似linux的top命令，它有多个运行参数。常用命令如下: jstat -gcutil [vmid]  vmid 即java进程Id(PID),vmid 可以根据jps命令获取到。例如: jstat -gcutil 20412,得到的结果如下所示:</p>
<pre><code>S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT
0.81   0.00  78.06  32.64  93.06  89.60    784   17.194    70   72.187   89.381
</code></pre><p>S0: survivor 0 区占用的百分比(KB)<br>S1: survivor 1 区占用的百分比(KB)<br>E: Eden 区占用的百分比(KB)<br>O: 老年代占用的百分比(KB)<br>M: Metadata 空间利用率(KB)<br>CCS: 类压缩空间的百分比(KB)<br>YGC: Minor GC总次数<br>YGCT：Minor GC总耗时(s)<br>FGC: Full GC 总次数<br>FGCT: Full GC总耗时(s)<br>GCT: 用于垃圾回收的总时间(s)</p>
<p>更多Jstat 选项信息参考<a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jstat.html" target="_blank" rel="external">jstat命令官方文档</a></p>
<h3 id="5-3-Jinfo"><a href="#5-3-Jinfo" class="headerlink" title="5.3 Jinfo"></a>5.3 Jinfo</h3><p>jinfo命令是用来查看并修改java进程运行的VM参数的命令。使用方法: jinfo -flag [vmid]， 例如:</p>
<p><img src="/img/jinfo.png" alt=""></p>
<p>+ 表示启用了这个参数(用的是Parallel GC)<br>更多使用方法: jinfo -help<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Usage:</div><div class="line">    jinfo [option] &lt;pid&gt;</div><div class="line">        (to connect to running <span class="keyword">process</span>)</div><div class="line">    jinfo [option] &lt;executable &lt;core&gt;</div><div class="line">        (to connect to a core file)</div><div class="line">    jinfo [option] [server_id@]&lt;remote server IP or hostname&gt;</div><div class="line">        (to connect to remote debug server)</div><div class="line"></div><div class="line">where &lt;option&gt; is one of:</div><div class="line">    -flag &lt;name&gt;         to print the value of the named VM flag</div><div class="line">    -flag [+|-]&lt;name&gt;    to enable or disable the named VM flag  <span class="comment"># 这个参数就是开启或关闭某个VM功能</span></div><div class="line">    -flag &lt;name&gt;=&lt;value&gt; to set the named VM flag to the given value <span class="comment"># 这个就相当于开启并设置参数值</span></div><div class="line">    -flags               to print VM flags</div><div class="line">    -sysprops            to print Java system properties <span class="comment"># 列出系统所有属性(windows可能用不了)</span></div><div class="line">    &lt;no option&gt;          to print both of the above</div><div class="line">    -h | -help           to print this help message</div></pre></td></tr></table></figure></p>
<h3 id="5-4-Jmap"><a href="#5-4-Jmap" class="headerlink" title="5.4 Jmap"></a>5.4 Jmap</h3><p>jmap 用来查看java进程的堆栈信息，可根据选项打印到控制台或者保存到文件里面.<br>帮助信息: jmap -help<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">Usage:</div><div class="line">    jmap [option] &lt;pid&gt;</div><div class="line">        (to connect to running <span class="keyword">process</span>)</div><div class="line">    jmap [option] &lt;executable &lt;core&gt;</div><div class="line">        (to connect to a core file)</div><div class="line">    jmap [option] [server_id@]&lt;remote server IP or hostname&gt;</div><div class="line">        (to connect to remote debug server)</div><div class="line"></div><div class="line">where &lt;option&gt; is one of:</div><div class="line">    &lt;none&gt;               to print same info as Solaris pmap</div><div class="line">    -heap                to print java heap summary</div><div class="line">    -histo[:live]        to print histogram of java object heap; <span class="keyword">if</span> the <span class="string">"live"</span>   <span class="comment"># 直接在控制台打印java进程的内存使用信息</span></div><div class="line">                         suboption is specified, only count live objects</div><div class="line">    -clstats             to print class loader statistics</div><div class="line">    -finalizerinfo       to print information on objects awaiting finalization</div><div class="line">    -dump:&lt;dump-options&gt; to dump java heap <span class="keyword">in</span> hprof binary format</div><div class="line">                         dump-options:</div><div class="line">                           live         dump only live objects; <span class="keyword">if</span> not specified,</div><div class="line">                                        all objects <span class="keyword">in</span> the heap are dumped.</div><div class="line">                           format=b     binary format</div><div class="line">                           file=&lt;file&gt;  dump heap to &lt;file&gt;</div><div class="line">                         Example: jmap -dump:live,format=b,file=heap.bin &lt;pid&gt;</div><div class="line">    -F                   force. Use with -dump:&lt;dump-options&gt; &lt;pid&gt; or -histo</div><div class="line">                         to force a heap dump or histogram when &lt;pid&gt; does not</div><div class="line">                         respond. The <span class="string">"live"</span> suboption is not supported</div><div class="line">                         <span class="keyword">in</span> this mode.</div><div class="line">    -h | -help           to print this help message</div><div class="line">    -J&lt;flag&gt;             to pass &lt;flag&gt; directly to the runtime system</div></pre></td></tr></table></figure></p>
<p>例如： jmap -dump:format=b,file=f:\jmap.bin 13756<br>该命令会将 pid为13756进程id的信息保存到f盘的jmap.bin文件里，怎么打开？请看下文</p>
<h3 id="5-5-Jhat"><a href="#5-5-Jhat" class="headerlink" title="5.5 Jhat"></a>5.5 Jhat</h3><p>jhat命令就是用来打开jmap命令生成的二进制文件的，应为它是非常耗费内存和cpu的，所以一般会在自己本地环境运行这个命令来查看java进程内存使用信息，而不会在服务端做这种事。打开后，会在http服务器中将这些信息展示出来，默认端口为7000，可通过 -port 参数指定。<br>帮助信息: jhat -help<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">Usage:  jhat [-stack &lt;bool&gt;] [-refs &lt;bool&gt;] [-port &lt;port&gt;] [-baseline &lt;file&gt;] [-debug &lt;int&gt;] [-version] [-h|-help] &lt;file&gt;</div><div class="line"></div><div class="line">        -J&lt;flag&gt;          Pass &lt;flag&gt; directly to the runtime system. <span class="keyword">For</span></div><div class="line">                          example, -J-mx512m to use a maximum heap size of <span class="number">512</span>MB</div><div class="line">        -stack false:     Turn off tracking object allocation call stack.</div><div class="line">        -refs false:      Turn off tracking of references to objects</div><div class="line">        -port &lt;port&gt;:     Set the port <span class="keyword">for</span> the HTTP server.  Defaults to <span class="number">7000</span></div><div class="line">        -exclude &lt;file&gt;:  Specify a file that lists <span class="keyword">data</span> members that should</div><div class="line">                          be excluded from the reachableFrom query.</div><div class="line">        -baseline &lt;file&gt;: Specify a baseline object dump.  Objects <span class="keyword">in</span></div><div class="line">                          both heap dumps with the same ID and same class will</div><div class="line">                          be marked as not being <span class="string">"new"</span>.</div><div class="line">        -debug &lt;int&gt;:     Set debug level.</div><div class="line">                            <span class="number">0</span>:  No debug output</div><div class="line">                            <span class="number">1</span>:  Debug hprof file parsing</div><div class="line">                            <span class="number">2</span>:  Debug hprof file parsing, no server</div><div class="line">        -version          Report version number</div><div class="line">        -h|-help          Print this help and <span class="keyword">exit</span></div><div class="line">        &lt;file&gt;            The file to read</div><div class="line"></div><div class="line"><span class="keyword">For</span> a dump file that contains multiple heap dumps,</div><div class="line">you may specify which dump <span class="keyword">in</span> the file</div><div class="line">by appending <span class="string">"#&lt;number&gt;"</span> to the file name, i.e. <span class="string">"foo.hprof#3"</span>.</div><div class="line"></div><div class="line">All boolean options default to <span class="string">"true"</span></div></pre></td></tr></table></figure></p>
<p>例如: jhat f:\jmap.bin<br>等待一会，看到 Started HTTP server on port 7000 字样的时候，打开 <a href="http://127.0.0.1:7000" target="_blank" rel="external">http://127.0.0.1:7000</a> 就可以看到所有的实例信息了，这里我们主要看两个地方，一个是 <a href="http://127.0.0.1:7000/histo/" target="_blank" rel="external">http://127.0.0.1:7000/histo/</a> ，查看Heap Histogram，查看的是所有类型对象的实例总数和实例大小。还有一个是 <a href="http://127.0.0.1:7000/oql/，" target="_blank" rel="external">http://127.0.0.1:7000/oql/，</a> 一个oql（Object query Language）查询工具，和sql一样，可以根据条件筛选出指定的对象，例如下面这个语句就是用来查询所有字符串长度大于1000的字符串对象:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> s <span class="keyword">from</span> java.lang.String s <span class="keyword">where</span> s.value.length &gt; <span class="number">1000</span></div></pre></td></tr></table></figure></p>
<p>更多有关oql的语法可以查看他的帮助文档 <a href="http://127.0.0.1:7000/oqlhelp/" target="_blank" rel="external">http://127.0.0.1:7000/oqlhelp/</a></p>
<h3 id="5-6-Jstack"><a href="#5-6-Jstack" class="headerlink" title="5.6 Jstack"></a>5.6 Jstack</h3><p>jstack 命令就是用来查看java进程的线程信息的一个工具。帮助: jstack -help<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Usage:</div><div class="line">    jstack [-l] &lt;pid&gt;</div><div class="line">        (to connect to running <span class="keyword">process</span>)</div><div class="line">    jstack -F [-m] [-l] &lt;pid&gt;</div><div class="line">        (to connect to a hung <span class="keyword">process</span>)</div><div class="line">    jstack [-m] [-l] &lt;executable&gt; &lt;core&gt;</div><div class="line">        (to connect to a core file)</div><div class="line">    jstack [-m] [-l] [server_id@]&lt;remote server IP or hostname&gt;</div><div class="line">        (to connect to a remote debug server)</div><div class="line"></div><div class="line">Options:</div><div class="line">    -F  to force a thread dump. Use when jstack &lt;pid&gt; does not respond (<span class="keyword">process</span> is hung)</div><div class="line">    -m  to print both java and native frames (mixed mode)</div><div class="line">    -l  long listing. Prints additional information about locks</div><div class="line">    -h or -help to print this help message</div></pre></td></tr></table></figure></p>
<p>例如: jstack -l 13756<br>会在控制台打印出许多有关的线程信息，其实也就是Thread的getAllStackTraces() 方法返回出来的信息，截取其中的一段显示如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">"Netty Builtin Server 1" #16 prio=5 os_prio=0 tid=0x0000000018f2b000 nid=0x2100 runnable [0x000000001bf3f000]</div><div class="line">   java.lang.Thread.State: RUNNABLE</div><div class="line">        at sun.nio.ch.WindowsSelectorImpl$SubSelector.poll0(Native Method)</div><div class="line">        at sun.nio.ch.WindowsSelectorImpl$SubSelector.poll(WindowsSelectorImpl.java:<span class="number">296</span>)</div><div class="line">        at sun.nio.ch.WindowsSelectorImpl$SubSelector.access$<span class="number">400</span>(WindowsSelectorImpl.java:<span class="number">278</span>)</div><div class="line">        at sun.nio.ch.WindowsSelectorImpl.doSelect(WindowsSelectorImpl.java:<span class="number">159</span>)</div><div class="line">        at sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:<span class="number">86</span>)</div><div class="line">        - locked &lt;<span class="number">0x00000000e155f760</span>&gt; (a io.netty.channel.nio.SelectedSelectionKeySet)</div><div class="line">        - locked &lt;<span class="number">0x00000000e155f790</span>&gt; (a java.util.Collections$UnmodifiableSet)</div><div class="line">        - locked &lt;<span class="number">0x00000000e29d20e8</span>&gt; (a sun.nio.ch.WindowsSelectorImpl)</div><div class="line">        at sun.nio.ch.SelectorImpl.select(SelectorImpl.java:<span class="number">97</span>)</div><div class="line">        at io.netty.channel.nio.SelectedSelectionKeySetSelector.select(SelectedSelectionKeySetSelector.java:<span class="number">62</span>)</div><div class="line">        at io.netty.channel.nio.NioEventLoop.select(NioEventLoop.java:<span class="number">752</span>)</div><div class="line">        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:<span class="number">408</span>)</div><div class="line">        at io.netty.util.concurrent.SingleThreadEventExecutor$<span class="number">5</span>.run(SingleThreadEventExecutor.java:<span class="number">858</span>)</div><div class="line">        at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</div><div class="line"></div><div class="line">   Locked ownable synchronizers:</div><div class="line">        - None</div></pre></td></tr></table></figure>
<h3 id="5-7Jconsole-和-VisualVM"><a href="#5-7Jconsole-和-VisualVM" class="headerlink" title="5.7Jconsole 和 VisualVM"></a>5.7Jconsole 和 VisualVM</h3><p>Jconsole是jdk自带的可视化分析工具，VisualVM是一个集众多jvm分析插件工具于一身的jvm强大实时可视化分析工具，Jconsole在VisualVM中就是一个插件而已，主页<a href="https://visualvm.github.io/" target="_blank" rel="external">VisualVM</a>。能有效分析内存分配和线程等等指标。VisualVM启动前需要配置jdk的路径，否则会显示找不到jdk。</p>
<h2 id="6-Class文件结构"><a href="#6-Class文件结构" class="headerlink" title="6 Class文件结构"></a>6 Class文件结构</h2><p>Class 文件是一组以8位字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑地排列在 Class 文件中，中间没有添加任何分隔符，这使得整个 Class 文件中存储的内容几乎全部都是程序运行的必要数据。根据 Java 虚拟机规范的规定，Class 文件格式采用一种类似于 C 语言结构体的伪结构来存储，这种伪结构中只有两种数据类型：无符号数和表。无符号数相当于java中的基本数据类型，以 u1、u2、u4、u8 来分别代表 1、2、4、8 个字节的无符号数。表相当于抽象数据类型，由多个无符号数或其他表作为数据项构成的复合数据类型，所有的表都习惯性地以“_info”结尾。整个 Class 文件本质上就是一张表，它由如下所示的数据项构成:</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>类型</th>
<th>数量</th>
</tr>
</thead>
<tbody>
<tr>
<td>magic</td>
<td>U4</td>
<td>1</td>
</tr>
<tr>
<td>minor_version</td>
<td>U2</td>
<td>1</td>
</tr>
<tr>
<td>major_version</td>
<td>U2</td>
<td>1</td>
</tr>
<tr>
<td>constant_pool_count</td>
<td>U2</td>
<td>1</td>
</tr>
<tr>
<td>constant_pool</td>
<td>cp_info</td>
<td>constant_pool_count - 1</td>
</tr>
<tr>
<td>access_flags</td>
<td>U2</td>
<td>1</td>
</tr>
<tr>
<td>this_class</td>
<td>U2</td>
<td>1</td>
</tr>
<tr>
<td>super_class</td>
<td>U2</td>
<td>1</td>
</tr>
<tr>
<td>interfaces_count</td>
<td>U2</td>
<td>1</td>
</tr>
<tr>
<td>interfaces</td>
<td>U2</td>
<td>interfaces_count</td>
</tr>
<tr>
<td>fields_count</td>
<td>U2</td>
<td>1</td>
</tr>
<tr>
<td>fields</td>
<td>field_info</td>
<td>fields_count</td>
</tr>
<tr>
<td>methods_count</td>
<td>U2</td>
<td>1</td>
</tr>
<tr>
<td>methods</td>
<td>method_info</td>
<td>methods_count</td>
</tr>
<tr>
<td>attributes_count</td>
<td>U2</td>
<td>1</td>
</tr>
<tr>
<td>attributes</td>
<td>attribute_info</td>
<td>attributes_count</td>
</tr>
</tbody>
</table>
<p>这个表的顺序就是class文件的解析顺序，接下来看一个 java 类(Hello.java)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.awt.event.ActionEvent;</div><div class="line"><span class="keyword">import</span> java.awt.event.ActionListener;</div><div class="line"><span class="keyword">import</span> java.io.FileInputStream;</div><div class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> <span class="keyword">extends</span> <span class="title">FileInputStream</span> <span class="keyword">implements</span> <span class="title">Runnable</span>,<span class="title">ActionListener</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Hello</span><span class="params">(String name)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</div><div class="line">        <span class="keyword">super</span>(name);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编译后的字节码为(Hello.class)：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">CA	FE	BA	BE	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">34</span>	<span class="number">00</span>	<span class="number">1F</span>	<span class="number">0</span>A	<span class="number">00</span>	<span class="number">04</span>	<span class="number">00</span>	<span class="number">18</span>	<span class="number">09</span></div><div class="line"><span class="number">00</span>	<span class="number">03</span>	<span class="number">00</span>	<span class="number">19</span>	<span class="number">07</span>	<span class="number">00</span>	<span class="number">1</span>A	<span class="number">07</span>	<span class="number">00</span>	<span class="number">1</span>B	<span class="number">07</span>	<span class="number">00</span>	<span class="number">1</span>C	<span class="number">07</span>	<span class="number">00</span>	<span class="number">1</span>D</div><div class="line"><span class="number">01</span>	<span class="number">00</span>	<span class="number">04</span>	<span class="number">6</span>E	<span class="number">61</span>	<span class="number">6</span>D	<span class="number">65</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">12</span>	<span class="number">4</span>C	<span class="number">6</span>A	<span class="number">61</span>	<span class="number">76</span>	<span class="number">61</span>	<span class="number">2F</span></div><div class="line"><span class="number">6</span>C	<span class="number">61</span>	<span class="number">6</span>E	<span class="number">67</span>	<span class="number">2F</span>	<span class="number">53</span>	<span class="number">74</span>	<span class="number">72</span>	<span class="number">69</span>	<span class="number">6</span>E	<span class="number">67</span>	<span class="number">3</span>B	<span class="number">01</span>	<span class="number">00</span>	<span class="number">06</span>	<span class="number">3</span>C</div><div class="line"><span class="number">69</span>	<span class="number">6</span>E	<span class="number">69</span>	<span class="number">74</span>	<span class="number">3</span>E	<span class="number">01</span>	<span class="number">00</span>	<span class="number">15</span>	<span class="number">28</span>	<span class="number">4</span>C	<span class="number">6</span>A	<span class="number">61</span>	<span class="number">76</span>	<span class="number">61</span>	<span class="number">2F</span>	<span class="number">6</span>C</div><div class="line"><span class="number">61</span>	<span class="number">6</span>E	<span class="number">67</span>	<span class="number">2F</span>	<span class="number">53</span>	<span class="number">74</span>	<span class="number">72</span>	<span class="number">69</span>	<span class="number">6</span>E	<span class="number">67</span>	<span class="number">3</span>B	<span class="number">29</span>	<span class="number">56</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">04</span></div><div class="line"><span class="number">43</span>	<span class="number">6F</span>	<span class="number">64</span>	<span class="number">65</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">0F</span>	<span class="number">4</span>C	<span class="number">69</span>	<span class="number">6</span>E	<span class="number">65</span>	<span class="number">4</span>E	<span class="number">75</span>	<span class="number">6</span>D	<span class="number">62</span>	<span class="number">65</span></div><div class="line"><span class="number">72</span>	<span class="number">54</span>	<span class="number">61</span>	<span class="number">62</span>	<span class="number">6</span>C	<span class="number">65</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">0</span>A	<span class="number">45</span>	<span class="number">78</span>	<span class="number">63</span>	<span class="number">65</span>	<span class="number">70</span>	<span class="number">74</span>	<span class="number">69</span></div><div class="line"><span class="number">6F</span>	<span class="number">6</span>E	<span class="number">73</span>	<span class="number">07</span>	<span class="number">00</span>	<span class="number">1</span>E	<span class="number">01</span>	<span class="number">00</span>	<span class="number">0F</span>	<span class="number">61</span>	<span class="number">63</span>	<span class="number">74</span>	<span class="number">69</span>	<span class="number">6F</span>	<span class="number">6</span>E	<span class="number">50</span></div><div class="line"><span class="number">65</span>	<span class="number">72</span>	<span class="number">66</span>	<span class="number">6F</span>	<span class="number">72</span>	<span class="number">6</span>D	<span class="number">65</span>	<span class="number">64</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">1F</span>	<span class="number">28</span>	<span class="number">4</span>C	<span class="number">6</span>A	<span class="number">61</span>	<span class="number">76</span></div><div class="line"><span class="number">61</span>	<span class="number">2F</span>	<span class="number">61</span>	<span class="number">77</span>	<span class="number">74</span>	<span class="number">2F</span>	<span class="number">65</span>	<span class="number">76</span>	<span class="number">65</span>	<span class="number">6</span>E	<span class="number">74</span>	<span class="number">2F</span>	<span class="number">41</span>	<span class="number">63</span>	<span class="number">74</span>	<span class="number">69</span></div><div class="line"><span class="number">6F</span>	<span class="number">6</span>E	<span class="number">45</span>	<span class="number">76</span>	<span class="number">65</span>	<span class="number">6</span>E	<span class="number">74</span>	<span class="number">3</span>B	<span class="number">29</span>	<span class="number">56</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">03</span>	<span class="number">72</span>	<span class="number">75</span>	<span class="number">6</span>E</div><div class="line"><span class="number">01</span>	<span class="number">00</span>	<span class="number">03</span>	<span class="number">28</span>	<span class="number">29</span>	<span class="number">56</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">07</span>	<span class="number">67</span>	<span class="number">65</span>	<span class="number">74</span>	<span class="number">4</span>E	<span class="number">61</span>	<span class="number">6</span>D	<span class="number">65</span></div><div class="line"><span class="number">01</span>	<span class="number">00</span>	<span class="number">14</span>	<span class="number">28</span>	<span class="number">29</span>	<span class="number">4</span>C	<span class="number">6</span>A	<span class="number">61</span>	<span class="number">76</span>	<span class="number">61</span>	<span class="number">2F</span>	<span class="number">6</span>C	<span class="number">61</span>	<span class="number">6</span>E	<span class="number">67</span>	<span class="number">2F</span></div><div class="line"><span class="number">53</span>	<span class="number">74</span>	<span class="number">72</span>	<span class="number">69</span>	<span class="number">6</span>E	<span class="number">67</span>	<span class="number">3</span>B	<span class="number">01</span>	<span class="number">00</span>	<span class="number">07</span>	<span class="number">73</span>	<span class="number">65</span>	<span class="number">74</span>	<span class="number">4</span>E	<span class="number">61</span>	<span class="number">6</span>D</div><div class="line"><span class="number">65</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">0</span>A	<span class="number">53</span>	<span class="number">6F</span>	<span class="number">75</span>	<span class="number">72</span>	<span class="number">63</span>	<span class="number">65</span>	<span class="number">46</span>	<span class="number">69</span>	<span class="number">6</span>C	<span class="number">65</span>	<span class="number">01</span>	<span class="number">00</span></div><div class="line"><span class="number">0</span>A	<span class="number">48</span>	<span class="number">65</span>	<span class="number">6</span>C	<span class="number">6</span>C	<span class="number">6F</span>	<span class="number">2</span>E	<span class="number">6</span>A	<span class="number">61</span>	<span class="number">76</span>	<span class="number">61</span>	<span class="number">0</span>C	<span class="number">00</span>	<span class="number">09</span>	<span class="number">00</span>	<span class="number">0</span>A</div><div class="line"><span class="number">0</span>C	<span class="number">00</span>	<span class="number">07</span>	<span class="number">00</span>	<span class="number">08</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">05</span>	<span class="number">48</span>	<span class="number">65</span>	<span class="number">6</span>C	<span class="number">6</span>C	<span class="number">6F</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">17</span></div><div class="line"><span class="number">6</span>A	<span class="number">61</span>	<span class="number">76</span>	<span class="number">61</span>	<span class="number">2F</span>	<span class="number">69</span>	<span class="number">6F</span>	<span class="number">2F</span>	<span class="number">46</span>	<span class="number">69</span>	<span class="number">6</span>C	<span class="number">65</span>	<span class="number">49</span>	<span class="number">6</span>E	<span class="number">70</span>	<span class="number">75</span></div><div class="line"><span class="number">74</span>	<span class="number">53</span>	<span class="number">74</span>	<span class="number">72</span>	<span class="number">65</span>	<span class="number">61</span>	<span class="number">6</span>D	<span class="number">01</span>	<span class="number">00</span>	<span class="number">12</span>	<span class="number">6</span>A	<span class="number">61</span>	<span class="number">76</span>	<span class="number">61</span>	<span class="number">2F</span>	<span class="number">6</span>C</div><div class="line"><span class="number">61</span>	<span class="number">6</span>E	<span class="number">67</span>	<span class="number">2F</span>	<span class="number">52</span>	<span class="number">75</span>	<span class="number">6</span>E	<span class="number">6</span>E	<span class="number">61</span>	<span class="number">62</span>	<span class="number">6</span>C	<span class="number">65</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">1</span>D	<span class="number">6</span>A</div><div class="line"><span class="number">61</span>	<span class="number">76</span>	<span class="number">61</span>	<span class="number">2F</span>	<span class="number">61</span>	<span class="number">77</span>	<span class="number">74</span>	<span class="number">2F</span>	<span class="number">65</span>	<span class="number">76</span>	<span class="number">65</span>	<span class="number">6</span>E	<span class="number">74</span>	<span class="number">2F</span>	<span class="number">41</span>	<span class="number">63</span></div><div class="line"><span class="number">74</span>	<span class="number">69</span>	<span class="number">6F</span>	<span class="number">6</span>E	<span class="number">4</span>C	<span class="number">69</span>	<span class="number">73</span>	<span class="number">74</span>	<span class="number">65</span>	<span class="number">6</span>E	<span class="number">65</span>	<span class="number">72</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">1</span>D	<span class="number">6</span>A</div><div class="line"><span class="number">61</span>	<span class="number">76</span>	<span class="number">61</span>	<span class="number">2F</span>	<span class="number">69</span>	<span class="number">6F</span>	<span class="number">2F</span>	<span class="number">46</span>	<span class="number">69</span>	<span class="number">6</span>C	<span class="number">65</span>	<span class="number">4</span>E	<span class="number">6F</span>	<span class="number">74</span>	<span class="number">46</span>	<span class="number">6F</span></div><div class="line"><span class="number">75</span>	<span class="number">6</span>E	<span class="number">64</span>	<span class="number">45</span>	<span class="number">78</span>	<span class="number">63</span>	<span class="number">65</span>	<span class="number">70</span>	<span class="number">74</span>	<span class="number">69</span>	<span class="number">6F</span>	<span class="number">6</span>E	<span class="number">00</span>	<span class="number">21</span>	<span class="number">00</span>	<span class="number">03</span></div><div class="line"><span class="number">00</span>	<span class="number">04</span>	<span class="number">00</span>	<span class="number">02</span>	<span class="number">00</span>	<span class="number">05</span>	<span class="number">00</span>	<span class="number">06</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">02</span>	<span class="number">00</span>	<span class="number">07</span>	<span class="number">00</span>	<span class="number">08</span></div><div class="line"><span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">05</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">09</span>	<span class="number">00</span>	<span class="number">0</span>A	<span class="number">00</span>	<span class="number">02</span>	<span class="number">00</span>	<span class="number">0</span>B	<span class="number">00</span>	<span class="number">00</span></div><div class="line"><span class="number">00</span>	<span class="number">22</span>	<span class="number">00</span>	<span class="number">02</span>	<span class="number">00</span>	<span class="number">02</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">06</span>	<span class="number">2</span>A	<span class="number">2</span>B	B7	<span class="number">00</span>	<span class="number">01</span>	B1</div><div class="line"><span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">0</span>C	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">0</span>A	<span class="number">00</span>	<span class="number">02</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">0</span>B</div><div class="line"><span class="number">00</span>	<span class="number">05</span>	<span class="number">00</span>	<span class="number">0</span>C	<span class="number">00</span>	<span class="number">0</span>D	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">04</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">0</span>E	<span class="number">00</span>	<span class="number">01</span></div><div class="line"><span class="number">00</span>	<span class="number">0F</span>	<span class="number">00</span>	<span class="number">10</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">0</span>B	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">19</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">02</span></div><div class="line"><span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">01</span>	B1	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">0</span>C	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">06</span>	<span class="number">00</span></div><div class="line"><span class="number">01</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">11</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">11</span>	<span class="number">00</span>	<span class="number">12</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">0</span>B	<span class="number">00</span></div><div class="line"><span class="number">00</span>	<span class="number">00</span>	<span class="number">19</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">01</span>	B1	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">01</span></div><div class="line"><span class="number">00</span>	<span class="number">0</span>C	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">06</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">16</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">13</span></div><div class="line"><span class="number">00</span>	<span class="number">14</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">0</span>B	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">1</span>D	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">00</span></div><div class="line"><span class="number">00</span>	<span class="number">05</span>	<span class="number">2</span>A	B4	<span class="number">00</span>	<span class="number">02</span>	B0	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">0</span>C	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span></div><div class="line"><span class="number">06</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">19</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">15</span>	<span class="number">00</span>	<span class="number">0</span>A	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span></div><div class="line"><span class="number">0</span>B	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">22</span>	<span class="number">00</span>	<span class="number">02</span>	<span class="number">00</span>	<span class="number">02</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">06</span>	<span class="number">2</span>A	<span class="number">2</span>B	B5</div><div class="line"><span class="number">00</span>	<span class="number">02</span>	B1	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">0</span>C	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">0</span>A	<span class="number">00</span>	<span class="number">02</span>	<span class="number">00</span></div><div class="line"><span class="number">00</span>	<span class="number">00</span>	<span class="number">1</span>D	<span class="number">00</span>	<span class="number">05</span>	<span class="number">00</span>	<span class="number">1</span>E	<span class="number">00</span>	<span class="number">01</span>	<span class="number">00</span>	<span class="number">16</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">00</span>	<span class="number">02</span>	<span class="number">00</span></div><div class="line"><span class="number">17</span></div></pre></td></tr></table></figure></p>
<p>这里的两个数字为一个字节，且都是10进制,首先名字为magic(魔数)的占四个字节,即 CA FE BA BE, 这个是标识这个文件为class文件的，不可能随便改个后缀名就是class文件了吧，读作: 咖啡baby（是不是和java的标志很像）. 第二个是 minor_version(次版本), 占两个字节，即 0000， 表明这个class文件的此版本号(class 文件作为一个规范也是有版本号的),接下来是主版本号0034，转成16进制为52，即jdk8对应的版本号。<br>接下来是constant_pool(常量池)相关的知识点了，常量池中主要存放两大类常量：字面量和符号引用。字面量比较接近于 Java 层面的常量概念，如文本字符串、被声明为 final 的常量值等。而符号引用总结起来则包括了下面三类常量：</p>
<ul>
<li>类和接口的全限定名（即带有包名的 Class 名，如：org.lxh.test.TestClass）</li>
<li>字段的名称和描述符（private、static 等描述符）</li>
<li>方法的名称和描述符（private、static 等描述符）<br>虚拟机在加载 Class 文件时才会进行动态连接，也就是说，Class 文件中不会保存各个方法和字段的最终内存布局信息，因此，这些字段和方法的符号引用不经过转换是无法直接被虚拟机使用的。当虚拟机运行时，需要从常量池中获得对应的符号引用，再在类加载过程中的解析阶段将其替换为直接引用，并翻译到具体的内存地址中。</li>
</ul>
<p>这里说明下符号引用和直接引用的区别与关联：</p>
<ul>
<li>符号引用：符号引用以一组符号来描述所引用的目标，符号可以是任何形式的字面量，只要使用时能无歧义地定位到目标即可。符号引用与虚拟机实现的内存布局无关，引用的目标并不一定已经加载到了内存中。</li>
<li>直接引用：直接引用可以是直接指向目标的指针、相对偏移量或是一个能间接定位到目标的句柄。直接引用是与虚拟机实现的内存布局相关的，同一个符号引用在不同虚拟机实例上翻译出来的直接引用一般不会相同。如果有了直接引用，那说明引用的目标必定已经存在于内存之中了。</li>
</ul>
<p>constant_pool 的类型 cp_info 的通用结构如下:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cp_info &#123;</div><div class="line">    u1 tag;</div><div class="line">    u1 info[];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>每个constant（常量）开头都是由1个字节的tag标识其属于哪种cp_info,下面是一个字节的info数组(其它信息，这里只是放在一个数组里面进行通用的描述)。在jdk8中，各种各样的constant_pool_tags如下表所示(共14种):</p>
<table>
<thead>
<tr>
<th>常量类型</th>
<th>值(10进制)</th>
</tr>
</thead>
<tbody>
<tr>
<td>CONSTANT_Class</td>
<td>7</td>
</tr>
<tr>
<td>CONSTANT_Fieldref</td>
<td>9</td>
</tr>
<tr>
<td>CONSTANT_Methodref</td>
<td>10</td>
</tr>
<tr>
<td>CONSTANT_InterfaceMethodref</td>
<td>11</td>
</tr>
<tr>
<td>CONSTANT_String</td>
<td>8</td>
</tr>
<tr>
<td>CONSTANT_Integer</td>
<td>3</td>
</tr>
<tr>
<td>CONSTANT_Float</td>
<td>4</td>
</tr>
<tr>
<td>CONSTANT_Long</td>
<td>5</td>
</tr>
<tr>
<td>CONSTANT_Double</td>
<td>6</td>
</tr>
<tr>
<td>CONSTANT_NameAndType</td>
<td>12</td>
</tr>
<tr>
<td>CONSTANT_Utf8</td>
<td>1</td>
</tr>
<tr>
<td>CONSTANT_MethodHandle</td>
<td>15</td>
</tr>
<tr>
<td>CONSTANT_MethodType</td>
<td>16</td>
</tr>
<tr>
<td>CONSTANT_InvokeDynamic</td>
<td>18</td>
</tr>
</tbody>
</table>
<p>这里面就包括上面所说的两大类常量:</p>
<ul>
<li>字面量: Utf8，Integer，Float，Long，Double，String</li>
<li>引用类型： Class，Fieldref，Methodref，InterfaceMethodref，NameAndType，MethodHandle，MethodType，InvokeDynamic</li>
</ul>
<p>接下来我们解析一下常量池部分<br>constatn_pool_count(常量池数量),001F表明有30个常量([1,31))，接下来是constant_pool(常量池), 由cp_info组成，首先根据tag找对应的tag信息(1字节)，开始是0A, 二进制的10(#1)，找到对应的 CONSTANT_Methodref 类常量(表明这是个引用类型的常量)，去<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html" target="_blank" rel="external">官方文档</a>找它的结构如下:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CONSTANT_Methodref_info &#123;</div><div class="line">    u1 tag;</div><div class="line">    u2 class_index;</div><div class="line">    u2 name_and_type_index;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后找class_index , 两个字节,0004,记住它引用的是4号常量(记作#4)，继续，name_and_type_index, 0018, 即24，引用的是24号常量(#24)。<br>再看下一个常量(#2): 09，表明是一个CONSTANT_Fieldref 类型的引用类型的常量。对应的结构为<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CONSTANT_Fieldref_info &#123;</div><div class="line">    u1 tag;</div><div class="line">    u2 class_index;</div><div class="line">    u2 name_and_type_index;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>和method一样,得到他的引用变量为3号常量(#3)和25号常量(#25).继续这样寻找下去，直到找到 CONSTANT_Utf8 字面量类型的常量，，然后根据他的结构信息<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CONSTANT_Utf8_info &#123;</div><div class="line">    u1 tag;</div><div class="line">    u2 length;</div><div class="line">    u1 bytes[length];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>得到它的具体值，length表明的是接下来有几个字节数。下来就是根据这写10进制数找到对应的ascii表的字母了。 其实以上信息可以用jdk自带的javap命令帮你读取出来：</p>
<p>执行: javap -verbose Hello.class<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">PS C:\Users\liu\Desktop&gt; javap -verbose .\Hello.class</div><div class="line">Classfile /C:/Users/liu/Desktop/Hello.class</div><div class="line">  Last modified <span class="number">2017</span>-<span class="number">11</span>-<span class="number">11</span>; size <span class="number">657</span> bytes</div><div class="line">  MD5 checksum <span class="number">8</span>ed8a940ffff9d0b7b27a59e1e90abe7</div><div class="line">  Compiled from <span class="string">"Hello.java"</span></div><div class="line">public class Hello extends java.io.FileInputStream implements java.lang.Runnable,java.awt.event.ActionListener</div><div class="line">  minor version: <span class="number">0</span></div><div class="line">  major version: <span class="number">52</span></div><div class="line">  flags: ACC_PUBLIC, ACC_SUPER</div><div class="line">Constant pool:</div><div class="line">   <span class="comment">#1 = Methodref          #4.#24         // java/io/FileInputStream."&lt;init&gt;":(Ljava/lang/String;)V</span></div><div class="line">   <span class="comment">#2 = Fieldref           #3.#25         // Hello.name:Ljava/lang/String;</span></div><div class="line">   <span class="comment">#3 = Class              #26            // Hello</span></div><div class="line">   <span class="comment">#4 = Class              #27            // java/io/FileInputStream</span></div><div class="line">   <span class="comment">#5 = Class              #28            // java/lang/Runnable</span></div><div class="line">   <span class="comment">#6 = Class              #29            // java/awt/event/ActionListener</span></div><div class="line">   <span class="comment">#7 = Utf8               name</span></div><div class="line">   <span class="comment">#8 = Utf8               Ljava/lang/String;</span></div><div class="line">   <span class="comment">#9 = Utf8               &lt;init&gt;</span></div><div class="line">  <span class="comment">#10 = Utf8               (Ljava/lang/String;)V</span></div><div class="line">  <span class="comment">#11 = Utf8               Code</span></div><div class="line">  <span class="comment">#12 = Utf8               LineNumberTable</span></div><div class="line">  <span class="comment">#13 = Utf8               Exceptions</span></div><div class="line">  <span class="comment">#14 = Class              #30            // java/io/FileNotFoundException</span></div><div class="line">  <span class="comment">#15 = Utf8               actionPerformed</span></div><div class="line">  <span class="comment">#16 = Utf8               (Ljava/awt/event/ActionEvent;)V</span></div><div class="line">  <span class="comment">#17 = Utf8               run</span></div><div class="line">  <span class="comment">#18 = Utf8               ()V</span></div><div class="line">  <span class="comment">#19 = Utf8               getName</span></div><div class="line">  <span class="comment">#20 = Utf8               ()Ljava/lang/String;</span></div><div class="line">  <span class="comment">#21 = Utf8               setName</span></div><div class="line">  <span class="comment">#22 = Utf8               SourceFile</span></div><div class="line">  <span class="comment">#23 = Utf8               Hello.java</span></div><div class="line">  <span class="comment">#24 = NameAndType        #9:#10         // "&lt;init&gt;":(Ljava/lang/String;)V</span></div><div class="line">  <span class="comment">#25 = NameAndType        #7:#8          // name:Ljava/lang/String;</span></div><div class="line">  <span class="comment">#26 = Utf8               Hello</span></div><div class="line">  <span class="comment">#27 = Utf8               java/io/FileInputStream</span></div><div class="line">  <span class="comment">#28 = Utf8               java/lang/Runnable</span></div><div class="line">  <span class="comment">#29 = Utf8               java/awt/event/ActionListener</span></div><div class="line">  <span class="comment">#30 = Utf8               java/io/FileNotFoundException</span></div></pre></td></tr></table></figure></p>
<p>下面这些#号开头的都是我们的常量信息。<br>常量信息结束后开始解析我们的 access_flags （访问标记），用工具可以看出来我们这里的访问标记为0021，这个是啥意思呢，还是看<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html" target="_blank" rel="external">官方文档</a>给我们的信息</p>
<table>
<thead>
<tr>
<th>标识名</th>
<th>值(16进制)</th>
</tr>
</thead>
<tbody>
<tr>
<td>ACC_PUBLIC</td>
<td>0x0001</td>
</tr>
<tr>
<td>ACC_FINAL</td>
<td>0x0010</td>
</tr>
<tr>
<td>ACC_SUPER</td>
<td>0x0020</td>
</tr>
<tr>
<td>ACC_INTERFACE</td>
<td>0x0200</td>
</tr>
<tr>
<td>ACC_ABSTRACT</td>
<td>0x0400</td>
</tr>
<tr>
<td>ACC_SYNTHETIC</td>
<td>0x1000</td>
</tr>
<tr>
<td>ACC_ANNOTATION</td>
<td>0x2000</td>
</tr>
<tr>
<td>ACC_ENUM</td>
<td>0x4000</td>
</tr>
</tbody>
</table>
<p>对几个特殊的标识解释一下：</p>
<ul>
<li>ACC_SUPER : 是否有超类(简单解释)</li>
<li>ACC_SYNTHETIC： 非源码中的类</li>
<li>ACC_ABSTRACT: 声明为抽象的，不可实例化的类。</li>
</ul>
<p>这就是我们的类的开始, 这个0021 就是 0020 加上 0001 的结果。也就是说这个类是PUBLIC的而且有父类。<br>接下来是this_class,占了两个字节，为0003，指向的是3号常量，可以查看上面的常量信息，看到是 Hello 这个类。接下来是 super_class,两个字节，0004，是 java/io/FileInputStream这个类， 下来是interfaces_count,这是因为java是单继承多实现机制的,才会有的这个变量.是0002，表明共有两个接口类，接下来看interfaces，共有两个，分别是0005 和 0006， 代表的是5号和6号变量，Runable 和 ActionListener,<br>下面继续就是变量，方法，属性的语义部分了，和类差不多，有访问标记，名字和修饰符，不同的是属性就是传参的属性和些格式的问题，可以参考<a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html" target="_blank" rel="external">官方文档</a>或者《java虚拟机规范(java se8版)》。其实我们的javap命令还有些输出上面没贴出来，这里加上注释，就能看出class文件后面的大概结构了<br><figure class="highlight powershell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  public Hello(java.lang.String) throws java.io.FileNotFoundException; <span class="comment">#构造函数，从这里可以看出编译器会为我们的类生成一个默认的构造函数方法</span></div><div class="line">    descriptor: (Ljava/lang/String;)V       <span class="comment"># 这个就是属性了，括号里面就是属性类型，L开头就是引用类型，括号外面的V标识返回类型为void类型</span></div><div class="line">    flags: ACC_PUBLIC                       <span class="comment"># 访问标记为Public类型</span></div><div class="line">    Code:                                   <span class="comment"># 这个Code标识方法</span></div><div class="line">      stack=<span class="number">2</span>, locals=<span class="number">2</span>, args_size=<span class="number">2</span>        <span class="comment">#stack表示方法的执行栈深度，最大为2， locals是局部变量表所需空间，用来存放方法内部的变量的，args_size为方法参数的数量，非static方法都会加上类的引用this参数，所以这里为2</span></div><div class="line">         <span class="number">0</span>: aload_0                         <span class="comment"># 这些是具体的指令名</span></div><div class="line">         <span class="number">1</span>: aload_1</div><div class="line">         <span class="number">2</span>: invokespecial <span class="comment">#1                  // Method java/io/FileInputStream."&lt;init&gt;":(Ljava/lang/String;)V</span></div><div class="line">         <span class="number">5</span>: <span class="keyword">return</span></div><div class="line">      LineNumberTable:</div><div class="line">        line <span class="number">11</span>: <span class="number">0</span></div><div class="line">        line <span class="number">12</span>: <span class="number">5</span></div><div class="line">    Exceptions:                             <span class="comment"># Exceptions标识方法抛出的异常</span></div><div class="line">      throws java.io.FileNotFoundException</div><div class="line"></div><div class="line">  public void actionPerformed(java.awt.event.ActionEvent);</div><div class="line">    descriptor: (Ljava/awt/event/ActionEvent;)V</div><div class="line">    flags: ACC_PUBLIC</div><div class="line">    Code:</div><div class="line">      stack=<span class="number">0</span>, locals=<span class="number">2</span>, args_size=<span class="number">2</span></div><div class="line">         <span class="number">0</span>: <span class="keyword">return</span></div><div class="line">      LineNumberTable:</div><div class="line">        line <span class="number">17</span>: <span class="number">0</span></div><div class="line"></div><div class="line">  public void run();</div><div class="line">    descriptor: ()V</div><div class="line">    flags: ACC_PUBLIC</div><div class="line">    Code:</div><div class="line">      stack=<span class="number">0</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></div><div class="line">         <span class="number">0</span>: <span class="keyword">return</span></div><div class="line">      LineNumberTable:</div><div class="line">        line <span class="number">22</span>: <span class="number">0</span></div><div class="line"></div><div class="line">  public java.lang.String getName();</div><div class="line">    descriptor: ()Ljava/lang/String;</div><div class="line">    flags: ACC_PUBLIC</div><div class="line">    Code:</div><div class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></div><div class="line">         <span class="number">0</span>: aload_0</div><div class="line">         <span class="number">1</span>: getfield      <span class="comment">#2                  // Field name:Ljava/lang/String;</span></div><div class="line">         <span class="number">4</span>: areturn</div><div class="line">      LineNumberTable:</div><div class="line">        line <span class="number">25</span>: <span class="number">0</span></div><div class="line"></div><div class="line">  public void setName(java.lang.String);</div><div class="line">    descriptor: (Ljava/lang/String;)V</div><div class="line">    flags: ACC_PUBLIC</div><div class="line">    Code:</div><div class="line">      stack=<span class="number">2</span>, locals=<span class="number">2</span>, args_size=<span class="number">2</span></div><div class="line">         <span class="number">0</span>: aload_0</div><div class="line">         <span class="number">1</span>: aload_1</div><div class="line">         <span class="number">2</span>: putfield      <span class="comment">#2                  // Field name:Ljava/lang/String;</span></div><div class="line">         <span class="number">5</span>: <span class="keyword">return</span></div><div class="line">      LineNumberTable:</div><div class="line">        line <span class="number">29</span>: <span class="number">0</span></div><div class="line">        line <span class="number">30</span>: <span class="number">5</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>扩展:<a href="http://blog.csdn.net/u014629433/article/details/51601201" target="_blank" rel="external">jvm解析系列］［六］class里的常量池，访问标志，类的继承关系</a></p>
<h2 id="7-类加载机制"><a href="#7-类加载机制" class="headerlink" title="7. 类加载机制"></a>7. 类加载机制</h2><p>先来看类加载流程图</p>
<p><img src="/img/类加载流程.png" alt=""></p>
<p>注意: 这里的加载和连接时并行进行的(加载一开始，连接也开始进行)，和流程图画的不同。<br>再来细看每一步jvm做的事情:</p>
<h3 id="7-1-加载"><a href="#7-1-加载" class="headerlink" title="7.1 加载"></a>7.1 加载</h3><p>加载需做一下三件事:</p>
<ol>
<li>通过一个类的全限定名来获取其定义的二进制字节流。</li>
<li>将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。</li>
<li>在Java堆中生成一个代表这个类的java.lang.Class对象，作为对方法区中这些数据的访问入口。</li>
</ol>
<p>第一条中的二进制流并不只是从class文件中获取，共有以下几种获取方式:</p>
<ul>
<li>class文件</li>
<li>网络(Applet)</li>
<li>计算生成(jdk的动态代理)</li>
<li>jar包</li>
<li>其它文件生成(jsp等)</li>
</ul>
<p>加载是通过类加载器来进行的，可以自定义类加载器(重写ClassLoader类的loadClass方法)来实现自定义类的加载过程。最终会将加载的二进制流储存进线程共享的方法区中，并且会在java堆中生成一个java.lang.Class对象，这样可以通过这个对象访问方法区中的数据。</p>
<h3 id="7-2-验证"><a href="#7-2-验证" class="headerlink" title="7.2 验证"></a>7.2 验证</h3><p>验证主要是验证Class文件中的字节流符合当前虚拟机的规范，主要包括一下四种</p>
<ul>
<li>文件格式验证(魔数)</li>
<li>元数据验证(java数据类型)</li>
<li>字节码验证(对代码进行校验，保证虚拟机安全运行)</li>
<li>引用验证(看常量池中的各种引用符号进行匹配性校验)</li>
</ul>
<h3 id="7-3-准备"><a href="#7-3-准备" class="headerlink" title="7.3 准备"></a>7.3 准备</h3><p>准备是正式的给类变量分配内存和初始值的一个阶段，所有属于类的变量(static)就分配到方法区里面，实例变量则会在对象实例化时随着对象一块分配在java堆中，同时根据不同类型的变量赋予不同的初始值。注意，这个时候并不会直接给变量赋予代码里的那个具体数值(常量除外)。还有几点:</p>
<ul>
<li>对于基本数据类型来说，类变量(static)和全局变量，如果没有给他显示的赋予值，虚拟机会为它赋予默认的初始值.如果是局部变量没有赋予初始值的话，就会报编译错误。</li>
<li>对于同时被static和final修饰的常量，必须在声明的时候就为其显式地赋值，否则编译时不通过；而只被final修饰的常量则既可以在声明时显式地为其赋值，也可以在类初始化时显式地为其赋值，总之，在使用前必须为其显式地赋值，系统不会为其赋予默认零值。</li>
<li>对于引用数据类型reference来说，如数组引用、对象引用等，如果没有对其进行显式地赋值而直接使用，系统都会为其赋予默认的零值，即null。</li>
<li>如果在数组初始化时没有对数组中的各元素赋值，那么其中的元素将根据对应的数据类型而被赋予默认的零值。</li>
</ul>
<h3 id="7-4-解析"><a href="#7-4-解析" class="headerlink" title="7.4 解析"></a>7.4 解析</h3><p>前面提到过符号引用这个概念，这个阶段就是将符号引用转为直接引用的过程。解析阶段的顺序不一定是在初始化之前，也有可能是在初始化之后，虚拟机会根据需要来判断，到底是在类被加载器加载时就对常量池中的符号引用进行解析（初始化之前），还是等到一个符号引用将要被使用前才去解析它(初始化之后)。对同一个符号引用进行多次解析请求时很常见的事情，虚拟机实现可能会对第一次解析的结果进行缓存（在运行时常量池中记录直接引用，并把常量标示为已解析状态），从而避免解析动作重复进行。</p>
<h3 id="7-5-初始化"><a href="#7-5-初始化" class="headerlink" title="7.5 初始化"></a>7.5 初始化</h3><p>初始化是类加载过程的最后一步，到了此阶段，才真正开始执行类中定义的Java程序代码。在准备阶段，类变量已经被赋过一次系统要求的初始值，而在初始化阶段，则是根据程序员通过程序指定的主观计划去初始化类变量和其他资源，或者可以从另一个角度来表达：初始化阶段是执行类构造器\<clinit\>()方法的过程。<br>这里简单说明下\<clinit\>（）方法的执行规则:</clinit\></clinit\></p>
<ol>
<li>\<clinit\>（）方法是由编译器自动收集类中的所有类变量的赋值动作和静态语句块中的语句合并产生的，编译器收集的顺序是由语句在源文件中出现的顺序所决定的，静态语句块中只能访问到定义在静态语句块之前的变量，定义在它之后的变量，在前面的静态语句中可以赋值，但是不能访问。</clinit\></li>
<li>\<clinit\>（）方法与实例构造器\<init\>（）方法（类的构造函数）不同，它不需要显式地调用父类构造器，虚拟机会保证在子类的\<clinit\>（）方法执行之前，父类的\<clinit\>（）方法已经执行完毕。因此，在虚拟机中第一个被执行的\<clinit\>（）方法的类肯定是java.lang.Object。</clinit\></clinit\></clinit\></init\></clinit\></li>
<li>\<clinit\>（）方法对于类或接口来说并不是必须的，如果一个类中没有静态语句块，也没有对类变量的赋值操作，那么编译器可以不为这个类生成\<clinit\>（）方法。</clinit\></clinit\></li>
<li>接口中不能使用静态语句块，但仍然有类变量（final static）初始化的赋值操作，因此接口与类一样会生成\<clinit\>（）方法。但是与类不同的是：执行接口的\<clinit\>（）方法不需要先执行父接口的\<clinit\>（）方法，只有当父接口中定义的变量被使用时，父接口才会被初始化。另外，接口的实现类在初始化时也一样不会执行接口的\<clinit\>（）方法。</clinit\></clinit\></clinit\></clinit\></li>
<li>多线程情况下只会给类执行一遍\<clinit\>()方法.</clinit\></li>
</ol>
<h3 id="7-6-类加载器与双亲委派模型"><a href="#7-6-类加载器与双亲委派模型" class="headerlink" title="7.6 类加载器与双亲委派模型"></a>7.6 类加载器与双亲委派模型</h3><p>一张图说明类加载器的执行方式:</p>
<p><img src="/img/类加载器.png" alt=""></p>
<ul>
<li>启动类加载器：Bootstrap ClassLoader，跟上面相同。它负责加载存放在JDK\jre\lib(JDK代表JDK的安装目录，下同)下，或被-Xbootclasspath参数指定的路径中的，并且能被虚拟机识别的类库（如rt.jar，所有的java.*开头的类均被Bootstrap ClassLoader加载）。启动类加载器是无法被Java程序直接引用的。</li>
<li>扩展类加载器：Extension ClassLoader，该加载器由sun.misc.Launcher$ExtClassLoader实现，它负责加载JDK\jre\lib\ext目录中，或者由java.ext.dirs系统变量指定的路径中的所有类库（如javax.*开头的类），开发者可以直接使用扩展类加载器。</li>
<li>应用程序类加载器：Application ClassLoader，该类加载器由sun.misc.Launcher$AppClassLoader来实现，它负责加载用户类路径（ClassPath）所指定的类，开发者可以直接使用该类加载器，如果应用程序中没有自定义过自己的类加载器，一般情况下这个就是程序中默认的类加载器。</li>
<li>自定义类加载器: 重写ClassLoader中的loadClass方法就可自定义实现。主要优点是高度的灵活性，可实现代码的热部署，class文件的解密等等。</li>
</ul>
<p>下麦呢看一下官方实现的类加载器loadClass方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String var1, <span class="keyword">boolean</span> var2) <span class="keyword">throws</span> ClassNotFoundException &#123;</div><div class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>.getClassLoadingLock(var1)) &#123;</div><div class="line">            Class var4 = <span class="keyword">this</span>.findLoadedClass(var1);                           <span class="comment">// 检查这个类是否被加载过</span></div><div class="line">            <span class="keyword">if</span> (var4 == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">long</span> var5 = System.nanoTime();</div><div class="line"></div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.parent != <span class="keyword">null</span>) &#123;</div><div class="line">                        var4 = <span class="keyword">this</span>.parent.loadClass(var1, <span class="keyword">false</span>);             <span class="comment">// 递归调用父类加载器去尝试加载( 应用程序类加载器 ---&gt; 扩展类加载器  ----&gt; 启动类加载器 )</span></div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        var4 = <span class="keyword">this</span>.findBootstrapClassOrNull(var1);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException var10) &#123;</div><div class="line">                    ;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (var4 == <span class="keyword">null</span>) &#123;                                           <span class="comment">// 如果还是加载不成功，就自己去实现加载功能。</span></div><div class="line">                    <span class="keyword">long</span> var7 = System.nanoTime();</div><div class="line">                    var4 = <span class="keyword">this</span>.findClass(var1);</div><div class="line">                    PerfCounter.getParentDelegationTime().addTime(var7 - var5);</div><div class="line">                    PerfCounter.getFindClassTime().addElapsedTimeFrom(var7);</div><div class="line">                    PerfCounter.getFindClasses().increment();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (var2) &#123;</div><div class="line">                <span class="keyword">this</span>.resolveClass(var4);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> var4;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>扩展:<a href="http://blog.csdn.net/ns_code/article/details/17881581" target="_blank" rel="external">【深入Java虚拟机】之四：类加载机制</a></p>

            
            <p class="more">
                <a href="https://995270418l.github.io/2018/01/31/jvm/">Read More</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="https://995270418l.github.io/2018/01/31/jvm/" title="jvm学习(java se8)">
                
                    <img class="thumbnail" src="/img/default.png" data-echo="/img/thumbnail/1.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    

    
    <nav class="page-navigator">
        <span class="page-number current">1</span>
    </nav>
    


            </div>

        </section>
        <!-- 侧栏部分 -->
<aside class="sidebar">
    <section class="widget">
        <h3 class="widget-hd"><strong>文章分类</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
    <li>
        <a href="/categories/Java/">Java</a>
        <span class="badge">(5)</span>
    </li>
    
    <li>
        <a href="/categories/健康生活/">健康生活</a>
        <span class="badge">(1)</span>
    </li>
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-hd"><strong>热门标签</strong></h3>
        <!-- 文章标签 -->
<div class="widget-bd tag-wrap">
  
    <a class="tag-item" href="/tags/spring-security/" title="spring security">spring security (1)</a>
  
    <a class="tag-item" href="/tags/spring-Oauth2/" title="spring Oauth2">spring Oauth2 (1)</a>
  
    <a class="tag-item" href="/tags/jvm/" title="jvm">jvm (1)</a>
  
    <a class="tag-item" href="/tags/jenkins/" title="jenkins">jenkins (1)</a>
  
    <a class="tag-item" href="/tags/powershell/" title="powershell">powershell (1)</a>
  
    <a class="tag-item" href="/tags/痔疮/" title="痔疮">痔疮 (1)</a>
  
    <a class="tag-item" href="/tags/算法/" title="算法">算法 (1)</a>
  
    <a class="tag-item" href="/tags/multipartThread/" title="multipartThread">multipartThread (1)</a>
  
</div>
    </section>
    

    

    
</aside>
<!-- / 侧栏部分 -->
    </div>

    <!-- 博客底部 -->
    <footer class="footer">
    &copy;
    
        2016-2018
    

    <a href="/">Steve Loves You</a>
</footer>
<div class="back-to-top" id="JELON__backToTop" title="返回顶部">返回顶部</div>

    <!--博客js脚本 -->
    <!-- 这里放网站js脚本 -->
<script src="/js/main.js"></script>
</body>
</html>